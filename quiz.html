<script>
// ================= æ ¸å¿ƒé€»è¾‘ä¿®æ”¹ç‰ˆ =================

// 1. è·å– URL ä¸­çš„ subject å‚æ•° (ä¾‹å¦‚ ?subject=python)
const urlParams = new URLSearchParams(window.location.search);
const currentSubject = urlParams.get('subject') || 'vue'; // é»˜è®¤æ˜¯ vue

// 2. åŠ¨æ€ç”Ÿæˆå­˜å‚¨ Keyï¼Œç¡®ä¿ä¸åŒç§‘ç›®çš„è¿›åº¦äº’ä¸å¹²æ‰°ï¼
const storeKey = 'quiz_pro_v1_' + currentSubject; 

// 3. åŠ¨æ€è®¾ç½®é¡µé¢æ ‡é¢˜
const subjectMap = {
    'vue': 'Vue.js',
    'python': 'Python',
    'os': 'æ“ä½œç³»ç»Ÿ',
    'network': 'è®¡ç®—æœºç½‘ç»œ',
    'mcu': 'å•ç‰‡æœº',
    'ds': 'æ•°æ®ç»“æ„',
    'se': 'è½¯ä»¶å·¥ç¨‹'
};
const titleText = (subjectMap[currentSubject] || currentSubject) + ' åˆ·é¢˜ Pro';
document.title = titleText;
document.querySelector('.brand-title').innerText = titleText;

let fullDB = []; // åˆå§‹ä¸ºç©ºï¼Œç­‰å¾…ä» JSON åŠ è½½

const state = {
    progress: {}, 
    mistakes: [],
    corrects: [],
    mode: 'all',
    isShuffle: false,
    currentList: [],
    multiTemp: [],
    clozeMap: {} 
};

const dom = {
    gridBox: document.getElementById('grid-box'),
    cardArea: document.getElementById('card-area'),
    statInfo: document.getElementById('stat-info'),
    modes: document.querySelectorAll('.mode-item'),
    shuffleBtn: document.getElementById('shuffle-btn')
};

// åˆå§‹åŒ–å‡½æ•° (ä¿®æ”¹ä¸ºåŠ¨æ€è¯»å–æ–‡ä»¶å)
async function init() {
    try {
        // åŠ¨æ€æ„å»ºæ–‡ä»¶åï¼švue.json, python.json, os.json ç­‰
        const fileName = currentSubject + '.json';
        
        // 1. åŠ è½½ å¯¹åº”ç§‘ç›®çš„ JSON æ•°æ®
        const response = await fetch(fileName + '?v=' + new Date().getTime());
        if (!response.ok) throw new Error(`æ— æ³•åŠ è½½é¢˜åº“æ–‡ä»¶: ${fileName} (è¯·ç¡®ä¿æ–‡ä»¶å·²ä¸Šä¼ )`);
        fullDB = await response.json();
        
        // 2. æ•°æ®åŠ è½½æˆåŠŸåï¼Œæ¢å¤çŠ¶æ€ (ä»£ç ä¸å˜)
        const saved = localStorage.getItem(storeKey);
        if (saved) {
            try {
                const data = JSON.parse(saved);
                state.mistakes = data.mistakes || [];
                state.corrects = data.corrects || [];
                state.progress = data.progress || {};
                state.isShuffle = !!data.isShuffle;
                if(data.lastMode) state.mode = data.lastMode;
            } catch(e) { console.error('Data load error', e); }
        }
        updateShuffleUI();
        changeMode(state.mode);

    } catch (e) {
        dom.cardArea.innerHTML = `<div style="text-align:center;padding:50px;color:red;">
            <h2>âŒ é¢˜åº“åŠ è½½å¤±è´¥</h2>
            <p>æ­£åœ¨å°è¯•åŠ è½½: <b>${currentSubject}.json</b></p>
            <p>è¯·ç¡®ä¿è¯¥æ–‡ä»¶å·²ä¸Šä¼ åˆ° GitHub ä¸”æ–‡ä»¶åæ­£ç¡®ã€‚</p>
            <p>é”™è¯¯è¯¦æƒ…: ${e.message}</p>
        </div>`;
        dom.statInfo.innerText = "åŠ è½½å¤±è´¥";
    }
}

// --- ä»¥ä¸‹æ‰€æœ‰åŠŸèƒ½å‡½æ•°ä¿æŒåŸæ ·ä¸åŠ¨ ---

function save() {
    if (state.mode !== 'mistakes') {
        state.progress[state.mode] = getCurrentIndex();
    }
    
    localStorage.setItem(storeKey, JSON.stringify({
        mistakes: state.mistakes,
        corrects: state.corrects,
        progress: state.progress,
        lastMode: state.mode,
        isShuffle: state.isShuffle
    }));
    updateUI();
}

function getCurrentIndex() {
    return state.idx || 0;
}

function formatText(text) {
    if(!text) return '';
    return text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

function shuffleArray(array) {
    let m = array.length, t, i;
    let copy = [...array]; 
    while (m) {
        i = Math.floor(Math.random() * m--);
        t = copy[m];
        copy[m] = copy[i];
        copy[i] = t;
    }
    return copy;
}

function toggleShuffle() {
    state.isShuffle = !state.isShuffle;
    updateShuffleUI();
    renderCard();
    save();
}

function updateShuffleUI() {
    if(state.isShuffle) {
        dom.shuffleBtn.classList.add('active');
        dom.shuffleBtn.innerText = 'ğŸ”€ é€‰é¡¹ä¹±åº: ON';
    } else {
        dom.shuffleBtn.classList.remove('active');
        dom.shuffleBtn.innerText = 'ğŸ”€ é€‰é¡¹ä¹±åº: OFF';
    }
}

function changeMode(mode) {
    state.mode = mode;
    state.multiTemp = [];
    
    dom.modes.forEach(el => {
        el.classList.toggle('active', el.innerText.includes(mode) || (mode==='all' && el.innerText.includes('å…¨')));
    });

    if (mode === 'all') state.currentList = [...fullDB];
    else if (mode === 'mistakes') state.currentList = fullDB.filter(q => state.mistakes.includes(q.id));
    else state.currentList = fullDB.filter(q => q.type === mode);

    if (mode === 'mistakes') {
        state.idx = 0;
        if(state.currentList.length === 0) {
            dom.cardArea.innerHTML = `<div style="text-align:center;padding:50px;color:#999;">ğŸ‰ é”™é¢˜æœ¬æ˜¯ç©ºçš„ï¼å¤ªæ£’äº†ï¼</div>`;
            renderGrid();
            return;
        }
    } else {
        let savedIdx = state.progress[mode] || 0;
        if (savedIdx >= state.currentList.length) savedIdx = 0;
        state.idx = savedIdx;
    }

    renderCard();
    renderGrid();
    updateUI();
}

// è¾…åŠ©ï¼šç”ŸæˆæŒ–ç©ºä»£ç HTML
function createClozeMode(codeText) {
    // 1. å°†ä»£ç æ‹†åˆ†ä¸º token æ•°ç»„ï¼ˆä¿ç•™åˆ†éš”ç¬¦ï¼‰
    const tokens = codeText.split(/([a-zA-Z0-9_$]+)/g);
    
    // 2. æ‰¾å‡ºæ‰€æœ‰â€œæœ‰æ„ä¹‰â€çš„å•è¯ç´¢å¼•
    const validIndices = [];
    tokens.forEach((t, i) => {
        if (/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(t) && t.length > 1) {
            validIndices.push(i);
        }
    });

    // 3. éšæœºé€‰5ä¸ªç´¢å¼•
    const shuffled = shuffleArray(validIndices);
    const selectedIndices = shuffled.slice(0, 5);
    
    // 4. æ„å»º HTML å’Œ ç­”æ¡ˆæ˜ å°„
    let html = '';
    const answers = {}; 
    let inputCount = 0;

    tokens.forEach((t, i) => {
        if (selectedIndices.includes(i)) {
            const currentCount = inputCount++;
            answers[currentCount] = t;
            const width = Math.max(40, t.length * 10);
            html += `<input type="text" class="cloze-input" data-idx="${currentCount}" style="width:${width}px" autocomplete="off">`;
        } else {
            html += formatText(t);
        }
    });

    return { html, answers };
}

// --- æ¸²æŸ“å¡ç‰‡ ---
function renderCard() {
    if(!state.currentList.length) return;
    const q = state.currentList[state.idx];
    const isMistake = state.mistakes.includes(q.id);
    const total = state.currentList.length;

    let safeQ = formatText(q.q);

    let html = `
        <div class="q-header">
            <span class="tag tag-type">${q.type}</span>
            ${isMistake ? '<span class="tag tag-err">é”™é¢˜æœ¬</span>' : ''}
            <span style="color:#aaa;margin-left:auto;font-size:0.9rem;">${state.idx + 1} / ${total}</span>
        </div>
        <div class="q-body">${q.id}. ${safeQ}</div>
    `;

    // 1. å•é€‰ (æ”¯æŒä¹±åº)
    if (q.type === 'å•é€‰é¢˜') {
        let opts = Object.entries(q.opts);
        if(state.isShuffle) opts = shuffleArray(opts);

        html += `<div class="opt-group">`;
        opts.forEach(([k, v]) => {
            html += `<div class="opt-btn" onclick="checkOne(this, '${k}', '${q.a}', ${q.id})">
                <span class="opt-key">${k}.</span><span class="opt-val">${formatText(v)}</span>
            </div>`;
        });
        html += `</div>`;
        html += renderDesc(q);
    }
    // 2. åˆ¤æ–­ (æ”¯æŒä¹±åº)
    else if (q.type === 'åˆ¤æ–­é¢˜') {
        let opts = ['å¯¹', 'é”™'];
        if(state.isShuffle) opts = shuffleArray(opts);

        html += `<div class="opt-group">`;
        opts.forEach(opt => {
            html += `<div class="opt-btn" onclick="checkOne(this, '${opt}', '${q.a}', ${q.id})">
                <span class="opt-val" style="text-align:center;font-weight:bold;">${opt}</span>
            </div>`;
        });
        html += `</div>`;
        html += renderDesc(q);
    }
    // 3. å¤šé€‰ (æ”¯æŒä¹±åº)
    else if (q.type === 'å¤šé€‰é¢˜') {
        state.multiTemp = [];
        let opts = Object.entries(q.opts);
        if(state.isShuffle) opts = shuffleArray(opts);

        html += `<div class="opt-group">`;
        opts.forEach(([k, v]) => {
            html += `<div class="opt-btn" id="mbtn-${k}" onclick="toggleMulti('${k}')">
                <span class="opt-key">${k}.</span><span class="opt-val">${formatText(v)}</span>
            </div>`;
        });
        html += `</div>`;
        html += `<button class="submit-btn" onclick="checkMulti(${q.id}, '${q.a}')">æäº¤ç­”æ¡ˆ (Enter)</button>`;
        html += renderDesc(q);
    }
    // 4. å¡«ç©ºé¢˜ & ç®€ç­”é¢˜
    else if (q.type === 'å¡«ç©ºé¢˜' || q.type === 'ç®€ç­”é¢˜') {
        html += `
            <div class="input-box-area">
                <textarea id="input-${q.id}" class="text-input" placeholder="è¯·è¾“å…¥ä½ çš„ç­”æ¡ˆ..."></textarea>
                <button class="submit-btn" onclick="checkTextAnswer(${q.id}, \`${q.a.replace(/`/g, '\\`')}\`, '${q.type}')">æäº¤ç­”æ¡ˆ (Enter)</button>
                <div id="feedback-${q.id}" class="input-feedback"></div>
            </div>
            <div id="flash-wrapper-${q.id}" style="display:none">
                <div class="flashcard-box" onclick="this.querySelector('.answer-reveal').style.display='block';this.style.cursor='default';">
                    <div style="font-weight:bold;color:#409eff;margin-bottom:10px;">å‚è€ƒç­”æ¡ˆ</div>
                    <div class="answer-reveal">
                        <div style="font-size:1.1rem;line-height:1.6;color:#2c3e50;">${formatText(q.a).replace(/\n/g, '<br>')}</div>
                    </div>
                </div>
            </div>
        `;
        html += renderDesc(q);
    }
    // 5. æ“ä½œé¢˜ - æŒ–ç©ºæ¨¡å¼
    else if (q.type === 'æ“ä½œé¢˜') {
        const { html: clozeHtml, answers } = createClozeMode(q.a);
        state.clozeMap[q.id] = answers; 

        html += `
            <div style="margin-bottom:15px;color:#666;font-size:0.9rem;">è¯·åœ¨ä»£ç ä¸­å¡«å†™ç¼ºå¤±çš„å…³é”®è¯ï¼š</div>
            <pre class="code-block" id="cloze-block-${q.id}">${clozeHtml}</pre>
            <button class="submit-btn" onclick="checkClozeAndSubmit(${q.id})">æäº¤ç­”æ¡ˆ (Enter)</button>
            <div id="feedback-${q.id}" class="input-feedback"></div>
            
            <div id="full-answer-${q.id}" style="display:none; margin-top:20px;">
                <div class="flashcard-box" style="padding:20px; text-align:left; border-color:#f56c6c; background:#fef0f0;">
                    <div style="font-weight:bold;color:#f56c6c;margin-bottom:10px;text-align:center;">âŒ å®Œæ•´å‚è€ƒä»£ç </div>
                    <pre class="code-block" style="background:#fff;border:1px solid #fde2e2;color:#333;">${formatText(q.a)}</pre>
                </div>
                ${renderDesc(q, true)}
            </div>
        `;
    }

    dom.cardArea.innerHTML = html;
    
    // è‡ªåŠ¨èšç„¦
    if (q.type === 'å¡«ç©ºé¢˜' || q.type === 'ç®€ç­”é¢˜') {
        setTimeout(() => {
            const el = document.getElementById(`input-${q.id}`);
            if(el) el.focus();
        }, 100);
    } else if (q.type === 'æ“ä½œé¢˜') {
        setTimeout(() => {
            const el = document.querySelector('.cloze-input');
            if(el) el.focus();
        }, 100);
    }
    
    save(); 
}

function renderDesc(q, showNow = false) {
    let safeDesc = formatText(q.desc);
    return `<div id="explain-${q.id}" class="explain-box" style="display:${showNow?'block':'none'}">
        <strong>ğŸ’¡ è§£æï¼š</strong>${safeDesc}
    </div>`;
}

function renderGrid() {
    let html = '';
    state.currentList.forEach((q, i) => {
        let cls = 'grid-item';
        if (i === state.idx) cls += ' current';
        else if (state.corrects.includes(q.id)) cls += ' done-ok';
        else if (state.mistakes.includes(q.id)) cls += ' done-err';
        
        html += `<div class="${cls}" onclick="jumpTo(${i})">${i+1}</div>`;
    });
    dom.gridBox.innerHTML = html;
}

function updateUI() {
    dom.statInfo.innerText = `é”™é¢˜ï¼š${state.mistakes.length} | å·²æŒæ¡ï¼š${state.corrects.length}`;
}

// ================= äº¤äº’é€»è¾‘ =================

// 1. å•é€‰/åˆ¤æ–­
function checkOne(el, val, correctAns, id) {
    if(el.parentElement.classList.contains('locked')) return;
    el.parentElement.classList.add('locked');

    const isRight = val === correctAns;
    const explain = document.getElementById(`explain-${id}`);
    
    if (isRight) {
        el.classList.add('correct');
        handleResult(id, true);
        if(explain) explain.style.display = 'block';
        setTimeout(() => nav(1), 1000); // 1ç§’åè·³è½¬
    } else {
        el.classList.add('wrong');
        handleResult(id, false);
        Array.from(el.parentElement.children).forEach(child => {
            let keyEl = child.querySelector('.opt-key');
            let text = child.innerText;
            if ((keyEl && keyEl.innerText.includes(correctAns)) || text === correctAns) {
                child.classList.add('correct');
            }
        });
        if(explain) explain.style.display = 'block';
    }
}

// 2. å¤šé€‰
function toggleMulti(key) {
    const btn = document.getElementById(`mbtn-${key}`);
    const idx = state.multiTemp.indexOf(key);
    if(idx > -1) {
        state.multiTemp.splice(idx, 1);
        btn.classList.remove('selected');
    } else {
        state.multiTemp.push(key);
        btn.classList.add('selected');
    }
}

function checkMulti(id, correctStr) {
    const correctArr = correctStr.replace(/[^A-Z]/g, '').split('').sort();
    const userArr = state.multiTemp.sort();
    const isRight = JSON.stringify(correctArr) === JSON.stringify(userArr);
    
    const btns = document.querySelectorAll('.opt-btn');
    btns.forEach(b => b.style.pointerEvents = 'none');
    document.querySelector('.submit-btn').style.display = 'none';
    
    const explain = document.getElementById(`explain-${id}`);
    if(explain) explain.style.display = 'block';

    if (isRight) {
        userArr.forEach(k => document.getElementById(`mbtn-${k}`).classList.add('correct'));
        handleResult(id, true);
        setTimeout(() => nav(1), 1000); // 1ç§’åè·³è½¬
    } else {
        userArr.forEach(k => {
            const btn = document.getElementById(`mbtn-${k}`);
            if(!correctArr.includes(k)) btn.classList.add('wrong');
            else btn.classList.add('correct');
        });
        correctArr.forEach(k => {
             const btn = document.getElementById(`mbtn-${k}`);
             if(!btn.classList.contains('correct')) btn.classList.add('correct');
        });
        handleResult(id, false);
    }
}

// 3. å¡«ç©º & ç®€ç­” åˆ¤æ–­é€»è¾‘
function checkTextAnswer(id, correctAns, type) {
    const inputEl = document.getElementById(`input-${id}`);
    const feedbackEl = document.getElementById(`feedback-${id}`);
    const flashEl = document.getElementById(`flash-wrapper-${id}`);
    const explainEl = document.getElementById(`explain-${id}`);
    const btn = document.querySelector('.submit-btn');

    let userVal = inputEl.value.trim();
    if (!userVal) {
        alert("è¯·è¾“å…¥å†…å®¹åå†æäº¤ï¼");
        return;
    }

    // ç¦ç”¨è¾“å…¥
    inputEl.disabled = true;
    btn.style.display = 'none';

    let isRight = false;
    let normalize = (str) => str.toLowerCase().replace(/\s+/g, '').replace(/ï¼Œ/g,',').replace(/ã€‚/g,'.');

    if (type === 'å¡«ç©ºé¢˜') {
        if (normalize(userVal) === normalize(correctAns)) {
            isRight = true;
        }
    } else {
        const cleanCorrect = normalize(correctAns);
        const cleanUser = normalize(userVal);
        if (cleanCorrect.length < 10) {
             isRight = (cleanCorrect === cleanUser);
        } else {
             const chars = cleanCorrect.split('');
             let matchCount = 0;
             chars.forEach(char => {
                 if (cleanUser.includes(char)) matchCount++;
             });
             if (matchCount / chars.length > 0.6) isRight = true;
        }
    }

    if (isRight) {
        inputEl.classList.add('inp-correct');
        feedbackEl.style.display = 'block';
        feedbackEl.className = 'input-feedback feedback-success';
        feedbackEl.innerHTML = `âœ… å›ç­”æ­£ç¡®ï¼`;
        if(explainEl) explainEl.style.display = 'block';
        handleResult(id, true);
        setTimeout(() => nav(1), 1000);
    } else {
        inputEl.classList.add('inp-wrong');
        feedbackEl.style.display = 'block';
        feedbackEl.className = 'input-feedback feedback-error';
        feedbackEl.innerHTML = `âŒ å›ç­”æœ‰è¯¯ï¼Œè¯·å‚è€ƒæ ‡å‡†ç­”æ¡ˆã€‚`;
        if(flashEl) {
            flashEl.style.display = 'block';
            flashEl.querySelector('.answer-reveal').style.display = 'block'; 
        }
        if(explainEl) explainEl.style.display = 'block';
        handleResult(id, false);
    }
}

// 4. æ“ä½œé¢˜æŒ–ç©ºåˆ¤æ–­é€»è¾‘
function checkClozeAndSubmit(id) {
    const answers = state.clozeMap[id];
    const inputs = document.querySelectorAll(`#cloze-block-${id} .cloze-input`);
    const btn = document.querySelector('.submit-btn');
    const feedbackEl = document.getElementById(`feedback-${id}`);
    const fullAnsEl = document.getElementById(`full-answer-${id}`);

    let allCorrect = true;

    inputs.forEach(inp => {
        const idx = inp.getAttribute('data-idx');
        const correctVal = answers[idx];
        const userVal = inp.value.trim();
        
        if (userVal === correctVal) {
            inp.classList.add('cloze-correct');
            inp.classList.remove('cloze-wrong');
        } else {
            inp.classList.add('cloze-wrong');
            inp.classList.remove('cloze-correct');
            allCorrect = false;
        }
        inp.disabled = true; // é”å®š
    });
    
    btn.style.display = 'none';

    if (allCorrect) {
        feedbackEl.style.display = 'block';
        feedbackEl.className = 'input-feedback feedback-success';
        feedbackEl.innerHTML = `âœ… å…¨éƒ¨æ­£ç¡®ï¼å¤ªå¼ºäº†ï¼`;
        handleResult(id, true);
        setTimeout(() => nav(1), 1000); // 1ç§’åè·³è½¬
    } else {
        feedbackEl.style.display = 'block';
        feedbackEl.className = 'input-feedback feedback-error';
        feedbackEl.innerHTML = `âŒ å­˜åœ¨é”™è¯¯ï¼Œè¯·å¯¹ç…§å®Œæ•´ä»£ç å¤ä¹ ã€‚`;
        if(fullAnsEl) fullAnsEl.style.display = 'block'; // æ˜¾ç¤ºå®Œæ•´ç­”æ¡ˆå’Œè§£æ
        handleResult(id, false);
        // ä¸è·³è½¬ï¼Œåœç•™
    }
}

function handleResult(id, success) {
    state.mistakes = state.mistakes.filter(x => x !== id);
    state.corrects = state.corrects.filter(x => x !== id);
    if(success) state.corrects.push(id);
    else state.mistakes.push(id);
    save();
    renderGrid();
}

function nav(step) {
    const n = state.idx + step;
    if (n >= 0 && n < state.currentList.length) {
        state.idx = n;
        renderCard();
        renderGrid();
    } else if (n >= state.currentList.length) {
        alert('ğŸ‰ æœ¬ç»„ç»ƒä¹ å·²å®Œæˆï¼');
    }
}

function jumpTo(i) {
    state.idx = i;
    renderCard();
    renderGrid();
}

function resetAll() {
    if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®°å½•ï¼ˆé”™é¢˜æœ¬ã€è¿›åº¦ã€å·²æŒæ¡ï¼‰å—ï¼Ÿ')) {
        localStorage.removeItem(storeKey);
        location.reload();
    }
}

document.addEventListener('keydown', (e) => {
    // å·¦å³é”®åˆ‡é¢˜
    if (e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'INPUT') {
        if (e.key === 'ArrowRight') nav(1);
        if (e.key === 'ArrowLeft') nav(-1);
    }
    
    // Enter æäº¤
    if (e.key === 'Enter') {
        if (e.target.tagName === 'TEXTAREA') {
            e.preventDefault(); 
            const sub = document.querySelector('.submit-btn');
            if(sub && sub.style.display !== 'none') sub.click();
        } else {
            const sub = document.querySelector('.submit-btn');
            if(sub && sub.offsetParent) sub.click();
        }
    }
    
    // é€‰é¡¹å¿«æ·é”®
    const q = state.currentList[state.idx];
    if(q && !state.isShuffle && (q.type === 'å•é€‰é¢˜' || q.type === 'åˆ¤æ–­é¢˜')) {
        const map = {'1':0, '2':1, '3':2, '4':3};
        if(map[e.key] !== undefined && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'INPUT') {
            const opts = document.querySelectorAll('.opt-btn');
            if(opts[map[e.key]]) opts[map[e.key]].click();
        }
    }
});

init();
</script>